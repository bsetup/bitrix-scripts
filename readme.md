# Полезные административные скрипты для Битрикс

## Отладка отправки писем

Диагностика отправки почты в Битрикс. Скрипт помогает выявить проблемы с почтой — показывает конфигурацию, обработчики событий и результат тестовой отправки.

**Что делает:**

1. Выводит конфигурацию почты — `email_from` главного модуля, email сайтов, SMTP из `.settings.php`, константы `ONLY_EMAIL` и `ERROR_EMAIL`.
2. Выводит зарегистрированные обработчики событий `OnBeforeEventAdd`, `OnBeforeMailSend`, `OnBeforePhpMail`.
3. Регистрирует логирующие обработчики на те же события для отслеживания процесса отправки.
4. Отправляет тестовое письмо двумя способами:
   - `Event::send` — отложенная отправка (запись в `b_event`),
   - `Event::sendImmediate` — немедленная отправка.

**Использование:**

1. Скопируйте содержимое файла [test_email.php](./test_email.php) после `<?php` и вставьте его в командную PHP-строку в админке `/bitrix/admin/php_command_line.php`
2. Задайте адрес получателя в переменной `$emailTo`
3. При необходимости измените настройки скрипта: сайт, тип почтового события и значения шаблона письма
4. В результате выполнения команды будет выведена отладочная информация

## Выбор устанавливаемых обновлений

При установке обновлений битрикс, необходимо вручную отщёлкивать модули, которые вы полностью удалили, но они остались доступны для вашей лицензии. Скрипт позволяет быстро выбрать только обновления установленных модулей.

**Использование:**

 1. Откройте страницу обновления `/bitrix/admin/update_system.php`
 2. Нажмите кнопку "Проверить обновления"
 3. Перейдите на вкладку "Список обновлений"
 4. Выполните этот код в инструментах разработчика браузера

```javascript
document.getElementById('table_updates_sel_list').querySelectorAll('tr').forEach((row) => {
    const cb = row.querySelector('input[type="checkbox"]');
    if (cb !== null) {
        cb.checked = row.querySelector('td:nth-child(3)').innerText.toLowerCase() === 'обновление';
    }
});
```

## Проверка пропавших файлов в `/upload/`

CLI-скрипт проверяет все записи таблицы `b_file` (кроме облачных хранилищ) и определяет, существует ли соответствующий физический файл в `/upload/`. Результат — CSV-файл со списком отсутствующих файлов.

**Что делает:**

1. Подключает ядро Битрикс с отключёнными агентами и статистикой.
2. Постранично (по 100 000) обходит все записи `b_file`, пропуская облачные (`HANDLER_ID IS NULL`).
3. Для каждой записи проверяет наличие файла `/upload/{SUBDIR}/{FILE_NAME}` на диске.
4. Записывает отсутствующие файлы в CSV (ID, MODULE_ID, TIMESTAMP_X, FILE_NAME, FILE_PATH).
5. Выводит прогресс в STDOUT — текущую страницу и счётчики найденных/отсутствующих файлов.

**Использование:**

1. Скопируйте [check_missing_bfile.php](./check_missing_bfile.php) на сервер в любое удобное место
2. Измените `DOCUMENT_ROOT` в начале скрипта на директорию вашего сайта
3. Запустите из CLI: `php check_missing_bfile.php`
4. CSV-файл с результатами появится рядом со скриптом, если будут найдены пропавшие файлы

## Замер скорости создания файлов

CLI-скрипт измеряет скорость создания файлов аналогично тесту в мониторе производительности Битрикс. Полезен для сравнения дисковой подсистемы на разных серверах или разделах без необходимости разворачивать Битрикс.

**Что делает:**

1. Принимает целевую директорию через аргумент `--test-dir` (по умолчанию — директория скрипта).
2. Выполняет 10 замеров, в каждом — 4 серии по 100 итераций создания, записи, подключения и удаления PHP-файла (~3 КБ).
3. Вычисляет среднее количество файловых операций в секунду и выводит результат каждого замера.

**Использование:**

1. Скопируйте [file_creation_performance.php](./file_creation_performance.php) на сервер
2. Запустите из CLI:
   ```bash
   php file_creation_performance.php
   php file_creation_performance.php --test-dir="./../../upload"
   php file_creation_performance.php --test-dir="/tmp"
   ```
3. Сравните результаты для разных директорий или серверов

## Авторизация в админку без пароля

Одноразовый веб-скрипт для экстренной авторизации в админку Битрикс. Авторизует под первым активным незаблокированным администратором и редиректит в `/bitrix/admin/`. После любого обращения (успешного или нет) скрипт удаляет сам себя.

**Что делает:**

1. Проверяет наличие секретного GET-параметра с правильным значением и срок действия (`ACCESSIBLE_UNTIL`).
2. При невалидном запросе — удаляет себя и возвращает HTTP 400.
3. Подключает ядро Битрикс, ищет первого активного незаблокированного администратора (группа 1).
4. Выполняет авторизацию от его имени и редиректит в `/bitrix/admin/`.
5. Удаляет себя в любом случае — после успешной авторизации, ошибки или исключения.

**Использование:**

1. Скопируйте [loginka.php](./loginka.php) в корень сайта (document root)
2. Задайте константы в начале файла:
   - `BSETUP_AUTO_AUTHORIZE_GET_PARAM_NAME` — имя GET-параметра (секретный ключ в URL)
   - `BSETUP_AUTO_AUTHORIZE_SECRET_KEY` — значение GET-параметра
   - `BSETUP_AUTO_AUTHORIZE_ACCESSIBLE_UNTIL` — UNIX-timestamp окончания доступа (`0` — без ограничения)
3. Откройте в браузере: `https://example.com/loginka.php?some_secret_key=test+password`
4. После использования скрипт удалит себя автоматически
